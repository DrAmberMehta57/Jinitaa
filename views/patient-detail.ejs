<%- include('partials/header') %>

    <div class="mb-6">
        <a href="/admin/dashboard" class="text-gray-600 hover:text-black font-semibold flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
                </path>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Patient Info Column -->
        <div class="lg:col-span-2 space-y-6">

            <!-- 1. Personal Information -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-gray-100 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-clinic-blue">
                        <%= patient.FullName %>
                    </h2>
                    <span class="bg-clinic-blue text-white text-xs font-bold px-2 py-1 rounded">
                        <%= patient.ReferenceID %>
                    </span>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Phone</label>
                        <p class="text-lg">
                            <%= patient.Phone %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Email</label>
                        <p class="text-lg">
                            <%= patient.Email || 'N/A' %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Date of Birth</label>
                        <p class="text-lg">
                            <%= patient.DOB %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Gender</label>
                        <p class="text-lg">
                            <%= patient.Gender %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Marital Status</label>
                        <p class="text-lg">
                            <%= patient.MaritalStatus || 'N/A' %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Occupation</label>
                        <p class="text-lg">
                            <%= patient.Occupation || 'N/A' %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Food Preference</label>
                        <p class="text-lg">
                            <%= patient.FoodPreference || 'N/A' %>
                        </p>
                    </div>
                    <div class="md:col-span-2"><label
                            class="block text-xs text-gray-500 uppercase font-bold">Address</label>
                        <p class="text-lg">
                            <%= patient.Address || 'N/A' %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2. Present Illness -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-clinic-green px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-white">Present Illness</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <h4 class="font-bold text-black mb-1">Chief Complaint</h4>
                        <p class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800">
                            <%= patient.ChiefComplaint %>
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-bold text-black mb-1">Duration</h4>
                            <p class="text-gray-800">
                                <%= patient.DurationOfIllness || 'N/A' %>
                            </p>
                        </div>
                        <div>
                            <h4 class="font-bold text-black mb-1">Severity</h4>
                            <p class="text-gray-800">
                                <%= patient.Severity || 'N/A' %>
                            </p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Symptom Description</h4>
                        <p class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800">
                            <%= patient.SymptomDescription || 'N/A' %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Aggravating Factors</h4>
                        <p class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800">
                            <%= patient.AggravatingFactors || 'N/A' %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Previous Treatments</h4>
                        <p class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800">
                            <%= patient.PreviousTreatments || 'N/A' %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- 3. Past & Family History -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-clinic-blue">History</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <h4 class="font-bold text-black mb-1">Past Medical History</h4>
                        <p class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800">
                            <%= patient.PastMedicalHistory || 'None' %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Allergies</h4>
                        <p class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800">
                            <%= patient.Allergies || 'None' %>
                        </p>
                    </div>

                    <div>
                        <h4 class="font-bold text-black mb-2">Family History</h4>
                        <% if (patient.FamilyMedicalHistory) { %>
                            <% try { const familyHistory=JSON.parse(patient.FamilyMedicalHistory); const
                                conditions=Object.keys(familyHistory); %>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm border-collapse border border-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="border p-2 text-left">Condition</th>
                                                <th class="border p-2">Patient</th>
                                                <th class="border p-2">Father</th>
                                                <th class="border p-2">Mother</th>
                                                <th class="border p-2">Siblings</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% conditions.forEach(cond=> {
                                                const members = familyHistory[cond] || {};
                                                // Only show row if at least one is checked
                                                if (Object.values(members).some(v => v === 'on')) {
                                                %>
                                                <tr>
                                                    <td class="border p-2 font-medium">
                                                        <%= cond %>
                                                    </td>
                                                    <td class="border p-2 text-center">
                                                        <%= members.Patient==='on' ? '✔' : '' %>
                                                    </td>
                                                    <td class="border p-2 text-center">
                                                        <%= members.Father==='on' ? '✔' : '' %>
                                                    </td>
                                                    <td class="border p-2 text-center">
                                                        <%= members.Mother==='on' ? '✔' : '' %>
                                                    </td>
                                                    <td class="border p-2 text-center">
                                                        <%= members.Siblings==='on' ? '✔' : '' %>
                                                    </td>
                                                </tr>
                                                <% } }); %>
                                        </tbody>
                                    </table>
                                </div>
                                <% } catch (e) { %>
                                    <p class="text-gray-500 italic">Error parsing family history.</p>
                                    <% } %>
                                        <% } else { %>
                                            <p class="text-gray-500 italic">No family history recorded.</p>
                                            <% } %>
                    </div>
                </div>
            </div>

            <!-- 4. Personal History -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-clinic-blue">Personal History</h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Sleep</label>
                        <p>
                            <%= patient.SleepPattern %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Appetite</label>
                        <p>
                            <%= patient.Appetite %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Thirst</label>
                        <p>
                            <%= patient.ThirstAndWater %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Bowels</label>
                        <p>
                            <%= patient.BowelHabits %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Urination</label>
                        <p>
                            <%= patient.Urination %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Thermal</label>
                        <p>
                            <%= patient.ThermalPreference %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Diet</label>
                        <p>
                            <%= patient.DietaryHabits %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Exercise</label>
                        <p>
                            <%= patient.ExerciseRoutine %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Habits</label>
                        <p>Tobacco: <%= patient.TobaccoUse %>
                                <%= patient.CigarettesPerDay ? `(${patient.CigarettesPerDay}/day)` : '' %>
                        </p>
                        <p>Alcohol: <%= patient.AlcoholUse %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- 5. Mind & Emotions -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-purple-100 px-6 py-4 border-b border-purple-200">
                    <h3 class="text-lg font-bold text-purple-800">Mind & Emotions</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <h4 class="font-bold text-black mb-1">Emotional State</h4>
                        <p class="text-gray-800">
                            <%= patient.EmotionalState %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Major Stressors</h4>
                        <p class="text-gray-800">
                            <%= patient.MajorLifeStressors %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Sleep & Dreams</h4>
                        <p class="text-gray-800">
                            <%= patient.SleepQualityDetails %>
                        </p>
                        <p class="text-gray-800 mt-1"><strong>Dreams:</strong>
                            <%= patient.DreamsNightmares %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Fears/Phobias</h4>
                        <p class="text-gray-800">
                            <%= patient.PhobiasFears %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Psychiatric History</h4>
                        <p class="text-gray-800">
                            <%= patient.PastPsychiatricHistory %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Self Description</h4>
                        <p class="text-gray-800 italic">"<%= patient.SelfDescription %>"</p>
                    </div>
                </div>
            </div>

            <!-- 6. Childhood -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-clinic-blue">Childhood History</h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2"><label
                            class="block text-xs text-gray-500 uppercase font-bold">Illnesses</label>
                        <p>
                            <%= patient.ChildhoodIllnesses %>
                        </p>
                    </div>
                    <div class="md:col-span-2"><label
                            class="block text-xs text-gray-500 uppercase font-bold">Development</label>
                        <p>
                            <%= patient.ChildhoodDevelopment %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Vaccinations</label>
                        <p>
                            <%= patient.Vaccinations %>
                        </p>
                    </div>
                    <div><label class="block text-xs text-gray-500 uppercase font-bold">Bedwetting</label>
                        <p>
                            <%= patient.Bedwetting %>
                        </p>
                    </div>
                    <div class="md:col-span-2"><label
                            class="block text-xs text-gray-500 uppercase font-bold">Traumas</label>
                        <p>
                            <%= patient.ChildhoodTraumas %>
                        </p>
                    </div>
                    <div class="md:col-span-2"><label
                            class="block text-xs text-gray-500 uppercase font-bold">Temperament</label>
                        <p>
                            <%= patient.ChildhoodTemperament %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- 7. Body Parts & Reports -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-clinic-blue">Affected Areas & Reports</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <h4 class="font-bold text-black mb-1">Affected Areas</h4>
                        <p class="text-clinic-blue font-semibold">
                            <%= patient.AffectedAreas || 'None specified' %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Pain Location</h4>
                        <p>
                            <%= patient.PainLocation %>
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-black mb-1">Comments</h4>
                        <p>
                            <%= patient.BodyPartComments %>
                        </p>
                    </div>

                    <div>
                        <h4 class="font-bold text-black mb-2">Uploaded Files</h4>
                        <% if (patient.ReportFiles) { const files=patient.ReportFiles.split(','); %>
                            <div class="flex flex-wrap gap-2">
                                <% files.forEach(file=> { %>
                                    <a href="<%= file %>" target="_blank"
                                        class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded border border-gray-300 transition">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                            </path>
                                        </svg>
                                        <span class="text-sm truncate max-w-xs">View Report</span>
                                    </a>
                                    <% }); %>
                            </div>
                            <% } else { %>
                                <p class="text-gray-500 italic">No files uploaded.</p>
                                <% } %>
                    </div>
                </div>
            </div>

            <!-- Previous Analyses -->
            <% if (remedies && remedies.length> 0) { %>
                <div class="bg-white rounded-lg shadow overflow-hidden mt-6">
                    <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                        <h3 class="text-lg font-bold text-white">Analysis History</h3>
                    </div>
                    <% remedies.forEach(rem=> { %>
                        <div class="p-4 border-b border-gray-200 last:border-0">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-gray-500">
                                    <%= new Date(rem.AnalysisDate).toLocaleString() %>
                                </span>
                                <span class="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded">
                                    <%= rem.Miasm %>
                                </span>
                            </div>
                            <div class="grid grid-cols-5 gap-2 mb-2">
                                <% [rem.Rem_1, rem.Rem_2, rem.Rem_3, rem.Rem_4, rem.Rem_5].forEach((r, i)=> { %>
                                    <% if(r) { %>
                                        <div
                                            class="bg-blue-50 text-blue-700 text-sm p-2 rounded text-center border border-blue-100">
                                            <span class="block text-xs text-gray-400">Remedy <%= i+1 %></span>
                                            <%= r %>
                                        </div>
                                        <% } %>
                                            <% }) %>
                            </div>
                            <% if(rem.Clinic_Notes) { %>
                                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded mt-2"><strong>Notes:</strong>
                                    <%= rem.Clinic_Notes %>
                                </p>
                                <% } %>
                        </div>
                        <% }) %>
                </div>
                <% } %>

        </div>

        <!-- Analysis Form Column -->
        <div class="lg:col-span-1">

            <!-- AI Suggestions -->
            <div
                class="bg-gradient-to-br from-indigo-900 to-purple-900 rounded-lg shadow overflow-hidden mb-6 text-white">
                <div class="px-6 py-4 border-b border-indigo-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold">AI Analysis Engine</h3>
                        <span class="text-xs bg-indigo-500 px-2 py-1 rounded">Beta</span>
                    </div>
                    <p class="text-xs text-indigo-200 mt-1">Analyze case based on symptoms & Materia Medica</p>
                </div>
                <div class="p-6 space-y-6">
                    <% if (typeof aiResults !=='undefined' && aiResults.topRemedies && aiResults.topRemedies.length> 0)
                        { %>

                        <!-- Top 5 Remedies -->
                        <div>
                            <h4 class="text-sm font-bold text-indigo-200 uppercase mb-3">Top 5 Indicated Remedies</h4>
                            <div class="space-y-3">
                                <% aiResults.topRemedies.forEach((rem, index)=> { %>
                                    <div class="bg-indigo-800 bg-opacity-50 p-3 rounded hover:bg-opacity-70 transition cursor-pointer"
                                        onclick="document.querySelector('input[name=rem<%= index + 1 %>]').value = '<%= rem.name %>';">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-bold text-white">
                                                <%= index + 1 %>. <%= rem.name %>
                                            </span>
                                            <span
                                                class="text-xs bg-indigo-600 px-2 py-0.5 rounded text-indigo-100">Score:
                                                <%= rem.score %></span>
                                        </div>
                                        <p class="text-xs text-indigo-200">
                                            <%= rem.profile %>
                                        </p>
                                        <p class="text-xs text-green-300 mt-1">Found: <%= rem.reason %>
                                        </p>
                                    </div>
                                    <% }); %>
                            </div>
                        </div>

                        <!-- Comparison Table (Top 3) -->
                        <% if (aiResults.comparison && aiResults.comparison.length> 0) { %>
                            <div>
                                <h4 class="text-sm font-bold text-indigo-200 uppercase mb-3">Differentiation (Top 3)
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-xs text-left text-indigo-100">
                                        <thead class="text-indigo-300 border-b border-indigo-700">
                                            <tr>
                                                <th class="py-2 pr-2">Feature</th>
                                                <th class="py-2 pr-2">
                                                    <%= aiResults.topRemedies[0].name %>
                                                </th>
                                                <th class="py-2 pr-2">
                                                    <%= aiResults.topRemedies[1].name %>
                                                </th>
                                                <th class="py-2">
                                                    <%= aiResults.topRemedies[2] ? aiResults.topRemedies[2].name : '-'
                                                        %>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-indigo-800">
                                            <% aiResults.comparison.forEach(row=> { %>
                                                <tr>
                                                    <td class="py-2 pr-2 font-semibold text-indigo-300">
                                                        <%= row.criteria %>
                                                    </td>
                                                    <td class="py-2 pr-2">
                                                        <%= row.rem1 %>
                                                    </td>
                                                    <td class="py-2 pr-2">
                                                        <%= row.rem2 %>
                                                    </td>
                                                    <td class="py-2">
                                                        <%= row.rem3 %>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <% } %>

                                <% } else { %>
                                    <div class="text-center py-4">
                                        <p class="text-indigo-300 italic mb-4">No strong analysis generated yet.</p>
                                        <button onclick="window.location.reload()"
                                            class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded text-sm transition">
                                            Analyze Case
                                        </button>
                                    </div>
                                    <% } %>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden sticky top-6">
                <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-white">Clinical Analysis</h3>
                    <p class="text-xs text-gray-400">Internal Use Only</p>
                </div>

                <form action="/admin/patient/<%= patient.PatientID %>/analysis" method="POST" class="p-6 space-y-4">

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Miasmatic Analysis</label>
                        <select name="miasm"
                            class="w-full border-2 border-gray-300 rounded p-2 focus:border-purple-500 focus:outline-none bg-white">
                            <option value="Mixed">Mixed</option>
                            <option value="Psoric">Psoric</option>
                            <option value="Sycotic">Sycotic</option>
                            <option value="Syphilitic">Syphilitic</option>
                            <option value="Tubercular">Tubercular</option>
                            <option value="Cancerous">Cancerous</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Recommended Remedies</label>
                        <div class="space-y-2">
                            <input type="text" name="rem1" placeholder="Remedy 1"
                                class="w-full border border-gray-300 rounded p-2 text-sm focus:border-clinic-blue focus:outline-none">
                            <input type="text" name="rem2" placeholder="Remedy 2"
                                class="w-full border border-gray-300 rounded p-2 text-sm focus:border-clinic-blue focus:outline-none">
                            <input type="text" name="rem3" placeholder="Remedy 3"
                                class="w-full border border-gray-300 rounded p-2 text-sm focus:border-clinic-blue focus:outline-none">
                            <input type="text" name="rem4" placeholder="Remedy 4"
                                class="w-full border border-gray-300 rounded p-2 text-sm focus:border-clinic-blue focus:outline-none">
                            <input type="text" name="rem5" placeholder="Remedy 5"
                                class="w-full border border-gray-300 rounded p-2 text-sm focus:border-clinic-blue focus:outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Doctor's Notes</label>
                        <textarea name="notes" rows="4"
                            class="w-full border border-gray-300 rounded p-2 text-sm focus:border-clinic-blue focus:outline-none"
                            placeholder="Confidential clinical observations..."></textarea>
                    </div>

                    <button type="submit"
                        class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-4 rounded transition duration-200">
                        Save Analysis
                    </button>
                </form>
            </div>
        </div>
    </div>
    <%- include('partials/footer') %>